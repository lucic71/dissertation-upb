\section{Running the benchmarks}

After developing all the flags that control the behavior of the compiler with
regards to undefined behavior exploitation, we started the performance
experiments. There is a total of 20 configurations that we used:
\begin{itemize}
  \item baseline, i.e. without any UB flag
  \item one UB flag at a time
  \item all UB flags combined
\end{itemize}

Considering that we have 25 benchmarks, each with a variable number of tests
that can finish in a matter of minutes or in a matter of hours, the whole
benchmarking process took us approximately two weeks for both our servers, i.e.
an Intel Xeon E5-2680 v2 @ 3.60GHz and an ARM Neoverse-N1 @ 3.00 GHz.

Before analyzing the results we had to make sure that the benchmarking
environment is stable so that our results do not show a high degree of variance.
In the past semester we ran a couple of experiments on the Intel server and we
have seen a satisfactory level of variance, e.g. 2\%. However, this semester we
also aquired an ARM server on which we ran the experiments and which showed
levels of variance way above the satisfactory threshold. This was a major
problem as no significant conclusion could be drawn from benchmarks with this
level of instability.

Figure~\ref{fig:EncoderModeSpeed6TwoPassInputBosphorus4K} shows a case of
variance in the aom-av1 benchmark. While configurations such as
-fconstrain-shift-value, -fdrop-align-attr, -fdrop-deref-attr have an
insignificant variance, configurations such as "-fdrop inbounds-from-gep -mllvm
-disable-oob-analysis" or -fignore-pure-const-attrs show variances between the
min value and the max value of 62\% or 106\%.

To solve the variance issues we found the following two methods to be effective:
\begin{itemize}
  \item Use numactl to pin the benchmarking process to a specific NUMA node
  \item Reduce the processor frequency
\end{itemize}

Figure~\ref{fig:EncoderModeSpeed11RealtimeInputBosphorus4K} shows the advantages
of these two techniques on the baseline configuration. Running at 3.00GHz
without numactl exposes outliers that are not found in the versions with reduced
frequency and numactl enabled. Even though for this specific case the variance
at 1.50GHz and at 2.00GHz seems acceptable, there are other tests in aom-av1
that do not show satisfactory variance for 1.50GHz and 2.00GHz. Because of this
we chose to decrease the frequency to 1.00GHz.

The question on why the benchmarks are more unsable on ARM than on x86 still
persists. We have a couple of theories on why this might happen but we need to
do more experiments in order to validate them. They include: CPU frequency
instability caused by the thermal controllers or unstable memory access times
caused by the memory access patterns displayed by the benchmarks. 

\begin{figure}[H]
  \centering
  \includesvg{EncoderModeSpeed11RealtimeInputBosphorus4K}
  \caption{Improvement of stability using numactl and frequency dropping}
  \label{fig:EncoderModeSpeed11RealtimeInputBosphorus4K}
\end{figure}

After solving the instability problems, we continued with gathering of results
on both Intel and ARM. Currently we have the -O2 numbers for both Intel and ARM,
we plan to continue to gather the numbes for -O3, -Os and -Oz.
